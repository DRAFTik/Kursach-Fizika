# 	#(для микрочелов) Создание коалиции:
# add_to_array = { coalition_array = NUM }	#NUM - номер партии по списку
# NW_legitimacy_check = yes
# 	#теперь в легитимность к правящей партии будет также прибавляться указанная партия. И да, в коалицию можно запихнуть хоть все партии

NW_legitimacy_check = {
	set_variable = { legitimacy_var = party_popularity_100@ruling_party }
	
	### НАЧАЛО ПРОВЕРКИ КОАЛИЦИЙ
	if = {
		limit = { is_in_array = { coalition_array = 1 } NOT = { has_government = democratic } }
		add_to_variable = { legitimacy_var = party_popularity_100@democratic }
	}
	if = {
		limit = { is_in_array = { coalition_array = 2 } NOT = { has_government = communism } }
		add_to_variable = { legitimacy_var = party_popularity_100@communism }
	}
	if = {
		limit = { is_in_array = { coalition_array = 3 } NOT = { has_government = fascism } }
		add_to_variable = { legitimacy_var = party_popularity_100@fascism }
	}
	if = {
		limit = { is_in_array = { coalition_array = 4 } NOT = { has_government = neutrality } }
		add_to_variable = { legitimacy_var = party_popularity_100@neutrality }
	}
	if = {
		limit = { is_in_array = { coalition_array = 5 } NOT = { has_government = technocracy } }
		add_to_variable = { legitimacy_var = party_popularity_100@technocracy }
	}
	if = {
		limit = { is_in_array = { coalition_array = 6 } NOT = { has_government = trozkism } }
		add_to_variable = { legitimacy_var = party_popularity_100@trozkism }
	}
	if = {
		limit = { is_in_array = { coalition_array = 7 } NOT = { has_government = monarchy } }
		add_to_variable = { legitimacy_var = party_popularity_100@monarchy }
	}
	if = {
		limit = { is_in_array = { coalition_array = 8 } NOT = { has_government = anarchism } }
		add_to_variable = { legitimacy_var = party_popularity_100@anarchism }
	}
	
	if = {
		limit = {
			OR = {
				AND = { is_in_array = { coalition_array = 1 } has_government = democratic }
				AND = { is_in_array = { coalition_array = 2 } has_government = communism }
				AND = { is_in_array = { coalition_array = 3 } has_government = fascism }
				AND = { is_in_array = { coalition_array = 4 } has_government = neutrality }
				AND = { is_in_array = { coalition_array = 5 } has_government = technocracy }
				AND = { is_in_array = { coalition_array = 6 } has_government = trozkism }
				AND = { is_in_array = { coalition_array = 7 } has_government = monarchy }
				AND = { is_in_array = { coalition_array = 8 } has_government = anarchism }
			}
		}
		subtract_from_variable = { legitimacy_var = party_popularity_100@ruling_party }
	}
	### КОНЕЦ ПРОВЕРКИ КОАЛИЦИЙ
	
	if = {
		limit = {
			NOT = {
				has_country_flag = very_good_legitimacy_flag
				has_country_flag = spain_block_legitimacy_flag
				has_government = anarchism
				has_idea = TIB_power_without_power
				has_idea = KHU_manual_state_management
				has_idea = IRQ_rejection_of_hashemites
			}
			if = {
				limit = {
					original_tag = MEN
					has_variable = MEN_legitimacy_var
				}
				always = no
			}
			else = {
				check_variable = { legitimacy_var > 84.9 }
			}
		}
		# Very Good Legitimacy 85% #
		set_variable = { num_new_legitimacy_idea_var = token:very_good }
		if = {
			limit = { date > 1936.1.2 }
			NW_set_legitimacy = yes
			set_country_flag = { flag = change_legitimacy_flag days = 4 value = 6 } #alert
		}
		else = {
			NW_startup_set_legitimacy = yes
		}
	}
	else_if = {
		limit = {
			NOT = {
				has_country_flag = good_legitimacy_flag
				has_country_flag = spain_block_legitimacy_flag
				has_government = anarchism
				has_idea = TIB_power_without_power
				has_idea = KHU_manual_state_management
				has_idea = IRQ_rejection_of_hashemites
			}
			if = {
				limit = {
					original_tag = MEN
					has_variable = MEN_legitimacy_var
				}
				always = no
			}
			else = {
				check_variable = { legitimacy_var > 64.9 }
				check_variable = { legitimacy_var < 85.0 }
			}
		}
		# Good Legitimacy 65 - 84.9% #
		set_variable = { num_new_legitimacy_idea_var = token:good }
		if = {
			limit = { date > 1936.1.2 }
			NW_set_legitimacy = yes
			set_country_flag = { flag = change_legitimacy_flag days = 4 value = 5 } #alert
		}
		else = {
			NW_startup_set_legitimacy  = yes
		}
	}
	else_if = {
		limit = {
			NOT = {
				has_country_flag = normal_legitimacy_flag
				has_country_flag = spain_block_legitimacy_flag
				has_idea = IRQ_rejection_of_hashemites
			}
			if = {
				limit = {
					original_tag = MEN
					has_variable = MEN_legitimacy_var
				}
				check_variable = { var = MEN_legitimacy_var value = 90 compare = less_than_or_equals }
				check_variable = { MEN_legitimacy_var > 60 }
			}
			else = {
				check_variable = { legitimacy_var > 49.9 }
				check_variable = { legitimacy_var < 65.0 }
			}
		}
		# Normal Legitimacy 50 - 64.9% #
		set_variable = { num_new_legitimacy_idea_var = token:normal }
		if = {
			limit = { date > 1936.1.2 }
			NW_set_legitimacy = yes
			set_country_flag = { flag = change_legitimacy_flag days = 4 value = 4 } #alert
		}
		else = {
			NW_startup_set_legitimacy = yes
		}
	}
	else_if = {
		limit = {
			NOT = {
				has_country_flag = low_legitimacy_flag
				has_country_flag = spain_block_legitimacy_flag
			}
			if = {
				limit = {
					original_tag = MEN
					has_variable = MEN_legitimacy_var
				}
				check_variable = { var = MEN_legitimacy_var value = 60 compare = less_than_or_equals }
				check_variable = { MEN_legitimacy_var > 30 }
			}
			else_if = {
				limit = {
					has_idea = IRQ_rejection_of_hashemites
				}
				check_variable = { party_popularity_100@ruling_party > 0.299 }
			}
			else = {
				check_variable = { legitimacy_var > 29.9 }
				check_variable = { legitimacy_var < 50.0 }
			}
		}
		# Low Legitimacy 30 - 49.9% #
		set_variable = { num_new_legitimacy_idea_var = token:low }
		if = {
			limit = { date > 1936.1.2 }
			NW_set_legitimacy = yes
			set_country_flag = { flag = change_legitimacy_flag days = 4 value = 3 } #alert
		}
		else = {
			NW_startup_set_legitimacy = yes
		}
	}
	else_if = {
		limit = {
			NOT = {
				has_country_flag = very_low_legitimacy_flag
				has_country_flag = spain_block_legitimacy_flag
			}
			if = {
				limit = {
					original_tag = MEN
					has_variable = MEN_legitimacy_var
				}
				check_variable = { var = MEN_legitimacy_var value = 30 compare = less_than_or_equals }
			}
			else = {
				check_variable = { legitimacy_var > 9.9 }
				check_variable = { legitimacy_var < 30.0 }
			}
		}
		# Very Low Legitimacy 10 - 29.9% #
		set_variable = { num_new_legitimacy_idea_var = token:very_low }
		if = {
			limit = { date > 1936.1.2 }
			NW_set_legitimacy = yes
			set_country_flag = { flag = change_legitimacy_flag days = 4 value = 2 } #alert
		}
		else = {
			NW_startup_set_legitimacy = yes
		}
	}
	else_if = {
		limit = {
			NOT = {
				has_country_flag = disaster_legitimacy_flag
				has_country_flag = spain_block_legitimacy_flag
				has_country_leader = { character = NFL_david_murray_anderson ruling_only = yes }
				has_country_leader = { character = NFL_humphrey_t_walwyn ruling_only = yes }
				has_country_leader = { character = NFL_gordon_macdonald ruling_only = yes }
				has_country_leader = { character = NFL_john_hope_simpson ruling_only = yes }
			}
			if = {
				limit = {
					original_tag = MEN
					has_variable = MEN_legitimacy_var
				}
				always = no
			}
			else = {
				check_variable = { legitimacy_var < 9.9 }
			}
		}
		# Disaster Legitimacy 9.9% #
		set_variable = { num_new_legitimacy_idea_var = token:disaster }
		if = {
			limit = { date > 1936.1.2 }
			NW_set_legitimacy = yes
			set_country_flag = { flag = change_legitimacy_flag days = 4 value = 1 } #alert
		}
		else = {
			NW_startup_set_legitimacy = yes
		}
	}
}

###

NW_set_legitimacy = {
	NW_set_GUI_legitimacy = yes
	meta_effect = {
		text = {
			swap_ideas = {
				remove_idea = [NUM_CURRENT_LEG_IDEA]_legitimacy
				add_idea = [NUM_NEW_LEG_IDEA]_legitimacy
			}
			clr_country_flag = [NUM_CURRENT_LEG_IDEA]_legitimacy_flag
			set_country_flag = [NUM_NEW_LEG_IDEA]_legitimacy_flag
			
			set_variable = { num_current_legitimacy_idea_var = token:[NUM_NEW_LEG_IDEA] }
		}
		NUM_NEW_LEG_IDEA = "[?num_new_legitimacy_idea_var.GetTokenKey]"
		NUM_CURRENT_LEG_IDEA = "[?num_current_legitimacy_idea_var.GetTokenKey]"
	}
	log = "[GetDateText]: [THIS.GetName] ([THIS.GetTag]): legitimacy_[?THIS.num_current_legitimacy_idea_var] | legitimacy_[?THIS.num_new_legitimacy_idea_var]" 
#	set_variable = { num_current_legitimacy_idea_var = num_new_legitimacy_idea_var }
}

NW_startup_set_legitimacy = {
	clr_country_flag = change_legitimacy_flag
	meta_effect = {
		text = {
			add_ideas = [NUM_NEW_LEG_IDEA]_legitimacy
			set_country_flag = [NUM_NEW_LEG_IDEA]_legitimacy_flag
			
			set_variable = { num_current_legitimacy_idea_var = token:[NUM_NEW_LEG_IDEA] }
		}
		NUM_NEW_LEG_IDEA = "[?num_new_legitimacy_idea_var.GetTokenKey]"
	}
	set_variable = { GUI_num_current_legitimacy_idea_var = num_current_legitimacy_idea_var }
#	set_variable = { num_current_legitimacy_idea_var = num_new_legitimacy_idea_var }
}

NW_set_GUI_legitimacy = {
	### ДЛЯ ГУИ
	set_variable = { GUI_num_current_legitimacy_idea_var = num_current_legitimacy_idea_var }
	set_variable = { GUI_num_new_legitimacy_idea_var = num_new_legitimacy_idea_var }
	
	set_temp_variable = { disaster_temp_var = token:disaster }
	set_temp_variable = { very_low_temp_var = token:very_low }
	set_temp_variable = { low_temp_var = token:low }
	set_temp_variable = { normal_temp_var = token:normal }
	set_temp_variable = { good_temp_var = token:good }
	set_temp_variable = { very_good_temp_var = token:very_good }
	
	if = {
		limit = { check_variable = { GUI_num_new_legitimacy_idea_var = disaster_temp_var } }
		set_variable = { GUI_new_legitimacy_idea_var_NUM = 6 }
	}
	else_if = {
		limit = { check_variable = { GUI_num_new_legitimacy_idea_var = very_low_temp_var } }
		set_variable = { GUI_new_legitimacy_idea_var_NUM = 5 }
	}
	else_if = {
		limit = { check_variable = { GUI_num_new_legitimacy_idea_var = low_temp_var } }
		set_variable = { GUI_new_legitimacy_idea_var_NUM = 4 }
	}
	else_if = {
		limit = { check_variable = { GUI_num_new_legitimacy_idea_var = normal_temp_var } }
		set_variable = { GUI_new_legitimacy_idea_var_NUM = 3 }
	}
	else_if = {
		limit = { check_variable = { GUI_num_new_legitimacy_idea_var = good_temp_var } }
		set_variable = { GUI_new_legitimacy_idea_var_NUM = 2 }
	}
	else_if = {
		limit = { check_variable = { GUI_num_new_legitimacy_idea_var = very_good_temp_var } }
		set_variable = { GUI_new_legitimacy_idea_var_NUM = 1 }
	}
	
	
	if = {
		limit = { check_variable = { GUI_num_current_legitimacy_idea_var = disaster_temp_var } }
		set_variable = { GUI_num_current_legitimacy_idea_var_NUM = 6 }
	}
	else_if = {
		limit = { check_variable = { GUI_num_current_legitimacy_idea_var = very_low_temp_var } }
		set_variable = { GUI_num_current_legitimacy_idea_var_NUM = 5 }
	}
	else_if = {
		limit = { check_variable = { GUI_num_current_legitimacy_idea_var = low_temp_var } }
		set_variable = { GUI_num_current_legitimacy_idea_var_NUM = 4 }
	}
	else_if = {
		limit = { check_variable = { GUI_num_current_legitimacy_idea_var = normal_temp_var } }
		set_variable = { GUI_num_current_legitimacy_idea_var_NUM = 3 }
	}
	else_if = {
		limit = { check_variable = { GUI_num_current_legitimacy_idea_var = good_temp_var } }
		set_variable = { GUI_num_current_legitimacy_idea_var_NUM = 2 }
	}
	else_if = {
		limit = { check_variable = { GUI_num_current_legitimacy_idea_var = very_good_temp_var } }
		set_variable = { GUI_num_current_legitimacy_idea_var_NUM = 1 }
	}
	
	
	if = {
		limit = { check_variable = { GUI_new_legitimacy_idea_var_NUM > GUI_num_current_legitimacy_idea_var_NUM } }
		set_variable = { GUI_up_or_down_status_var = 1 }	# плохо
	}
	else = {
		set_variable = { GUI_up_or_down_status_var = 2 }	# хорошо
	}
}